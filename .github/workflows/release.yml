name: Release

on:
  push:
    branches:
      - main

# Prevent concurrent releases
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    name: Build and Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Extract version and release notes from CHANGELOG
        id: changelog
        run: |
          # Extract the first version section (latest release)
          # This matches ## [X.Y.Z] - YYYY-MM-DD format
          VERSION=$(grep -m 1 -oP '## \[\K[0-9]+\.[0-9]+\.[0-9]+(?=\])' CHANGELOG.md)

          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from CHANGELOG.md"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

          # Extract release notes for this version
          # Get content between the first ## [x.x.x] and the next ## [x.x.x] or end of file
          NOTES=$(awk '/^## \['"$VERSION"'\]/{flag=1; next} /^## \[[0-9]+\.[0-9]+\.[0-9]+\]/{flag=0} flag' CHANGELOG.md)

          # Write notes to file to preserve formatting
          echo "$NOTES" > release_notes.md

          echo "Extracted version: $VERSION"
          echo "Release notes:"
          cat release_notes.md

      - name: Check if release already exists
        id: check_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="v${{ steps.changelog.outputs.version }}"
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release $TAG already exists, skipping..."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release $TAG does not exist, will create..."
          fi

      - name: Create release artifact
        if: steps.check_release.outputs.exists == 'false'
        run: |
          cd dist
          zip -r ../retro-cnc-panel-${{ steps.changelog.outputs.version }}.zip .

      - name: Create draft release
        if: steps.check_release.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "v${{ steps.changelog.outputs.version }}" \
            --title "Retro CNC Panel v${{ steps.changelog.outputs.version }}" \
            --notes-file release_notes.md \
            --draft \
            retro-cnc-panel-${{ steps.changelog.outputs.version }}.zip \
            docs/install.sh
